{% extends 'core/base.html' %}
{% load ui_extras %}

{% block title %}Produtos Sync{% endblock %}

{% block hero_title %}Produtos sincronizados{% endblock %}
{% block hero_subtitle %}Consulta somente leitura dos itens recebidos via integração{% endblock %}

{% block content %}
  <div class="box data-card" data-aos="fade-up">
    <header>
      <div>
        <h2 style="margin:0">Catálogo sincronizado</h2>
        <p class="small text-muted">Visualize os registros oriundos da integração externa.</p>
      </div>
      <div class="buttons">
        <span class="tag">{{ total }} itens</span>
        {% if last_sync_at %}
          <span class="tag is-light" title="{{ last_sync_at|date:'d/m/Y H:i:s' }}">
            Última sync: {{ last_sync_at|timesince }} atrás
          </span>
        {% else %}
          <span class="tag is-warning is-light">Última sync: sem registro</span>
        {% endif %}
        {% if user.is_staff %}
          <form method="post" action="{% url 'products:sync_apply' %}" style="display:flex; gap:0.5rem; align-items:center; margin:0;">
            {% csrf_token %}
            <button class="button is-primary" type="submit">Inserir produtos</button>
            <label class="checkbox small" style="margin:0;">
              <input type="checkbox" name="update" value="1">
              Atualizar existentes
            </label>
          </form>
        {% endif %}
      </div>
    </header>
  </div>

  <form method="get" class="surface filters-panel" data-aos="fade-up" data-aos-delay="60">
    <div class="filters-grid">
      <div>
        <label class="small text-muted" for="search-sync">Buscar por código, descrição, referência, EAN ou PLU</label>
        <div class="field has-addons is-fullwidth">
          <div class="control is-expanded has-icons-left">
            <input id="search-sync" class="input" type="search" name="q" placeholder="Pesquisar…" value="{{ filters.q }}">
            <span class="icon is-left" data-lucide="search"></span>
          </div>
          <div class="control"><button class="button is-primary" type="submit">Pesquisar</button></div>
          <div class="control"><a class="button is-secondary" href="{% url 'products:sync_list' %}">Limpar</a></div>
        </div>
      </div>
      <div class="filter-controls">
        <div class="field-group">
          <div class="control">
            <div class="select is-small">
              <select name="per_page" onchange="window.location=this.options[this.selectedIndex].dataset.href">
                {% for n in per_page_options %}
                  <option value="{{ n }}" data-href="{% per_page_url n %}" {% if per_page == n %}selected{% endif %}>{{ n }}/página</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <input type="hidden" name="sort" value="{{ sort }}">
        <input type="hidden" name="dir" value="{{ dir }}">
      </div>
    </div>
  </form>

  {% if filters.q %}
    <div class="tags are-medium" style="margin-top:0.5rem">
      <a class="tag is-info is-light" href="{% qs_url q=None page='1' %}">Busca: "{{ filters.q }}" ×</a>
      <a class="tag is-light" href="{% url 'products:sync_list' %}">Limpar</a>
    </div>
  {% endif %}

  <div class="box data-card" data-aos="fade-up" data-aos-delay="90">
    <table class="table is-fullwidth is-hoverable is-compact">
      <thead>
        <tr>
          <th style="width:140px">
            {% with col='codigo' %}
              <a href="{% sort_url col sort dir %}">Código {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th>
            {% with col='descricao' %}
              <a href="{% sort_url col sort dir %}">Descrição {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:150px">
            {% with col='referencia' %}
              <a href="{% sort_url col sort dir %}">Referência {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:140px">
            {% with col='ean' %}
              <a href="{% sort_url col sort dir %}">EAN {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:110px">
            {% with col='plu' %}
              <a href="{% sort_url col sort dir %}">PLU {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:140px; text-align:right">
            {% with col='preco' %}
              <a href="{% sort_url col sort dir %}">Preço normal {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:140px; text-align:right">
            {% with col='preco_promocional_1' %}
              <a href="{% sort_url col sort dir %}">Preço promo 1 {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:140px; text-align:right">
            {% with col='preco_promocional_2' %}
              <a href="{% sort_url col sort dir %}">Preço promo 2 {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:140px; text-align:right">
            {% with col='estoque' %}
              <a href="{% sort_url col sort dir %}">Estoque disp. {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
          <th style="width:100px">
            {% with col='loja' %}
              <a href="{% sort_url col sort dir %}">Loja {% sort_caret col sort dir %}</a>
            {% endwith %}
          </th>
        </tr>
      </thead>
      <tbody>
        {% if items %}
          {% for item in items %}
            <tr>
              <td><code>{{ item.codigo }}</code></td>
              <td>
                <strong>{{ item.descricao|default:"—" }}</strong>
              </td>
              <td>{{ item.referencia|default:item.reference|default:"—" }}</td>
              <td>{{ item.ean|default:"—" }}</td>
              <td>{{ item.plu|default:"—" }}</td>
              <td style="text-align:right">
                {% if item.preco_normal is not None %}
                  R$ {{ item.preco_normal|floatformat:2 }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="text-align:right">
                {% if item.preco_promocional_1 is not None %}
                  R$ {{ item.preco_promocional_1|floatformat:2 }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="text-align:right">
                {% if item.preco_promocional_2 is not None %}
                  R$ {{ item.preco_promocional_2|floatformat:2 }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td style="text-align:right">
                {% if item.estoque_disponivel is not None %}
                  {% if item.estoque_disponivel < 0 %}
                    <span class="has-text-danger">{{ item.estoque_disponivel|floatformat:2 }}</span>
                  {% else %}
                    {{ item.estoque_disponivel|floatformat:2 }}
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>{{ item.loja|default:"—" }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="has-text-centered text-muted">Nenhum registro encontrado.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    {% if is_paginated %}
      <nav class="pagination is-centered" role="navigation" aria-label="Paginação">
        {% if page_obj.has_previous %}
          <a class="pagination-previous" href="{% page_url page_obj.previous_page_number %}">Anterior</a>
        {% else %}
          <a class="pagination-previous" disabled>Anterior</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="pagination-next" href="{% page_url page_obj.next_page_number %}">Próxima</a>
        {% else %}
          <a class="pagination-next" disabled>Próxima</a>
        {% endif %}
        <ul class="pagination-list">
          {% for p in page_obj.paginator.page_range %}
            {% if p == page_obj.number %}
              <li><a class="pagination-link is-current">{{ p }}</a></li>
            {% else %}
              <li><a class="pagination-link" href="{% page_url p %}">{{ p }}</a></li>
            {% endif %}
          {% endfor %}
        </ul>
      </nav>
    {% endif %}
  </div>
{% endblock %}
