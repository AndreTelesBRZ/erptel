{% extends 'core/base.html' %}

{% block title %}Formulário de Cliente{% endblock %}

{% block hero_title %}{% if client %}Editar{% else %}Criar{% endif %} Cliente{% endblock %}
{% block hero_subtitle %}Preencha os dados cadastrais{% endblock %}

{% block content %}
  <div class="columns">
    <div class="column is-9">
      <div class="box">
        <form method="post">
          {% csrf_token %}
          <div class="columns">
            <div class="column is-4">
              <div class="field">
                <label class="label" for="{{ form.person_type.id_for_label }}">Tipo de pessoa</label>
                <div class="control">
                  {{ form.person_type }}
                </div>
                {% if form.person_type.errors %}
                  <p class="help is-danger">{{ form.person_type.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-4">
              <div class="field">
                <label class="label" for="{{ form.document.id_for_label }}">CPF/CNPJ</label>
                <div class="field has-addons">
                  <div class="control is-expanded">
                    {{ form.document }}
                  </div>
                  <div class="control">
                    <button class="button is-info" type="button" id="client-sefaz-button" data-sefaz-url="{% url 'clients:sefaz_lookup' %}" data-configured="{{ sefaz_configured|yesno:'true,false' }}">Consultar SEFAZ</button>
                  </div>
                </div>
                <p class="help {% if not sefaz_configured %}is-warning{% endif %}" id="client-sefaz-feedback" aria-live="polite">{% if not sefaz_configured %}SEFAZ API não está configurada. Acesse Sistema &gt; Configurações.{% endif %}</p>
                {% if form.document.errors %}
                  <p class="help is-danger">{{ form.document.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-4">
              <div class="field">
                <label class="label" for="{{ form.code.id_for_label }}">Código</label>
                <div class="control">
                  {{ form.code }}
                </div>
                <p class="help">Gerado automaticamente a partir do documento.</p>
                {% if form.code.errors %}
                  <p class="help is-danger">{{ form.code.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="columns">
            <div class="column">
              <div class="field">
                <label class="label">Nome</label>
                <div class="control">
                  {{ form.first_name }}
                </div>
                {% if form.first_name.errors %}
                  <p class="help is-danger">{{ form.first_name.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column">
              <div class="field">
                <label class="label">Sobrenome</label>
                <div class="control">
                  {{ form.last_name }}
                </div>
                {% if form.last_name.errors %}
                  <p class="help is-danger">{{ form.last_name.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="columns">
            <div class="column">
              <div class="field">
                <label class="label">Email</label>
                <div class="control">
                  {{ form.email }}
                </div>
                {% if form.email.errors %}
                  <p class="help is-danger">{{ form.email.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column">
              <div class="field">
                <label class="label">Telefone</label>
                <div class="control">
                  {{ form.phone }}
                </div>
                {% if form.phone.errors %}
                  <p class="help is-danger">{{ form.phone.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="columns">
            <div class="column is-4">
              <div class="field">
                {{ form.state_registration.label_tag }}
                <div class="control">
                  {{ form.state_registration }}
                </div>
                {% if form.state_registration.errors %}
                  <p class="help is-danger">{{ form.state_registration.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-4">
              <div class="field">
                {{ form.zip_code.label_tag }}
                <div class="control">
                  {{ form.zip_code }}
                </div>
                {% if form.zip_code.errors %}
                  <p class="help is-danger">{{ form.zip_code.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-4">
              <div class="field">
                {{ form.state.label_tag }}
                <div class="control">
                  {{ form.state }}
                </div>
                {% if form.state.errors %}
                  <p class="help is-danger">{{ form.state.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="columns">
            <div class="column is-6">
              <div class="field">
                {{ form.address.label_tag }}
                <div class="control">
                  {{ form.address }}
                </div>
                {% if form.address.errors %}
                  <p class="help is-danger">{{ form.address.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-3">
              <div class="field">
                {{ form.number.label_tag }}
                <div class="control">
                  {{ form.number }}
                </div>
                {% if form.number.errors %}
                  <p class="help is-danger">{{ form.number.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-3">
              <div class="field">
                {{ form.complement.label_tag }}
                <div class="control">
                  {{ form.complement }}
                </div>
                {% if form.complement.errors %}
                  <p class="help is-danger">{{ form.complement.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="columns">
            <div class="column is-6">
              <div class="field">
                {{ form.district.label_tag }}
                <div class="control">
                  {{ form.district }}
                </div>
                {% if form.district.errors %}
                  <p class="help is-danger">{{ form.district.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-6">
              <div class="field">
                {{ form.city.label_tag }}
                <div class="control">
                  {{ form.city }}
                </div>
                {% if form.city.errors %}
                  <p class="help is-danger">{{ form.city.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="field is-grouped is-justify-content-flex-end">
            <div class="control">
              <button class="button is-primary" type="submit">Salvar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="column is-3">
      <div class="box">
        <p class="small text-muted">Dica</p>
        <p>Use emails válidos para exportação e contato rápido.</p>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const button = document.getElementById('client-sefaz-button');
      const docInput = document.getElementById('{{ form.document.id_for_label }}');
      const feedback = document.getElementById('client-sefaz-feedback');
      const personType = document.getElementById('{{ form.person_type.id_for_label }}');
      const codeInput = document.getElementById('{{ form.code.id_for_label }}');
      const firstName = document.getElementById('{{ form.first_name.id_for_label }}');
      const lastName = document.getElementById('{{ form.last_name.id_for_label }}');
      const emailInput = document.getElementById('{{ form.email.id_for_label }}');
      const phoneInput = document.getElementById('{{ form.phone.id_for_label }}');
      const stateRegistration = document.getElementById('{{ form.state_registration.id_for_label }}');
      const addressInput = document.getElementById('{{ form.address.id_for_label }}');
      const numberInput = document.getElementById('{{ form.number.id_for_label }}');
      const complementInput = document.getElementById('{{ form.complement.id_for_label }}');
      const districtInput = document.getElementById('{{ form.district.id_for_label }}');
      const cityInput = document.getElementById('{{ form.city.id_for_label }}');
      const stateInput = document.getElementById('{{ form.state.id_for_label }}');
      const zipInput = document.getElementById('{{ form.zip_code.id_for_label }}');

      if (!button || !docInput || !feedback) {
        return;
      }

      const setFeedback = function (message, statusClass) {
        feedback.textContent = message || '';
        feedback.classList.remove('is-danger', 'is-success', 'is-info', 'is-warning');
        if (statusClass) {
          feedback.classList.add(statusClass);
        }
      };

      const isConfigured = button.dataset.configured === 'true';

      const updateButtonState = function () {
        if (!isConfigured) {
          setFeedback('SEFAZ API não está configurada. Acesse Sistema > Configurações.', 'is-warning');
          button.disabled = true;
          return;
        }
        if (!personType) {
          const hasSuccess = feedback.classList.contains('is-success');
          if (!button.classList.contains('is-loading') && !hasSuccess) {
            setFeedback('', null);
          }
          button.disabled = false;
          return;
        }
        if (personType.value !== 'J') {
          setFeedback('Consulta disponível apenas para Pessoa Jurídica.', 'is-info');
          button.disabled = true;
          return;
        }
        const hasSuccess = feedback.classList.contains('is-success');
        if (!button.classList.contains('is-loading') && !hasSuccess) {
          setFeedback('', null);
        }
        button.disabled = false;
      };

      if (personType) {
        updateButtonState();
        personType.addEventListener('change', updateButtonState);
      }

      button.addEventListener('click', async function () {
        const endpoint = button.dataset.sefazUrl;
        if (!endpoint) {
          setFeedback('Endpoint da SEFAZ não configurado.', 'is-danger');
          return;
        }

        if (!isConfigured) {
          setFeedback('SEFAZ API não está configurada. Acesse Sistema > Configurações.', 'is-warning');
          return;
        }

        if (personType && personType.value !== 'J') {
          personType.value = 'J';
          personType.dispatchEvent(new Event('change', { bubbles: true }));
        }

        const cnpj = (docInput.value || '').trim();
        if (!cnpj) {
          setFeedback('Informe um CNPJ para consultar.', 'is-info');
          docInput.focus();
          return;
        }

        button.classList.add('is-loading');
        button.disabled = true;
        setFeedback('Consultando dados da SEFAZ...', 'is-info');

        try {
          const url = new URL(endpoint, window.location.origin);
          url.searchParams.set('cnpj', cnpj);
          const response = await fetch(url.toString(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          });

          let body = {};
          try {
            body = await response.json();
          } catch (error) {
            if (!response.ok) {
              throw new Error('Não foi possível obter os dados da SEFAZ.');
            }
          }

          if (!response.ok) {
            throw new Error(body.error || 'Não foi possível obter os dados da SEFAZ.');
          }

          const data = body.data || {};
          const fieldMap = [
            [docInput, data.document],
            [codeInput, data.code],
            [firstName, data.first_name],
            [lastName, data.last_name],
            [emailInput, data.email],
            [phoneInput, data.phone],
            [stateRegistration, data.state_registration],
            [addressInput, data.address],
            [numberInput, data.number],
            [complementInput, data.complement],
            [districtInput, data.district],
            [cityInput, data.city],
            [stateInput, data.state],
            [zipInput, data.zip_code],
          ];

          fieldMap.forEach(([el, value]) => {
            if (!el || value === undefined || value === null) {
              return;
            }
            el.value = value || '';
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
          });

          if (personType && data.person_type) {
            personType.value = data.person_type;
            personType.dispatchEvent(new Event('change', { bubbles: true }));
          }

          setFeedback('Dados carregados da SEFAZ.', 'is-success');
        } catch (error) {
          setFeedback(error.message, 'is-danger');
        } finally {
          button.classList.remove('is-loading');
          updateButtonState();
        }
      });
    });
  </script>
{% endblock %}
