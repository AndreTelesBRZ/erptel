{% extends 'core/base.html' %}

{% block title %}Configurações • Novo usuário{% endblock %}
{% block hero_title %}Configurações{% endblock %}
{% block hero_subtitle %}Cadastre um novo usuário e defina suas funções{% endblock %}

{% block content %}
  {% include 'core/settings_nav.html' with active='access_create' %}

  <div class="columns" data-aos="fade-up">
    <div class="column is-two-thirds">
      <div class="box">
        <h2 class="title is-5" style="margin-bottom:1rem;">Novo usuário</h2>
        <form method="post">
          {% csrf_token %}
          {% if user_form.non_field_errors %}
            <div class="notification is-danger is-light">
              {% for error in user_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}
          {% if profile_form.non_field_errors %}
            <div class="notification is-danger is-light">
              {% for error in profile_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}
          <div class="columns is-multiline">
            <div class="column is-6">
              <div class="field">
                {{ user_form.username.label_tag }}
                <div class="control">
                  {{ user_form.username }}
                </div>
                {% if user_form.username.errors %}
                  <p class="help is-danger">{{ user_form.username.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-6">
              <div class="field">
                {{ user_form.email.label_tag }}
                <div class="control">
                  {{ user_form.email }}
                </div>
                {% if user_form.email.errors %}
                  <p class="help is-danger">{{ user_form.email.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-6">
              <div class="field">
                {{ user_form.first_name.label_tag }}
                <div class="control">
                  {{ user_form.first_name }}
                </div>
                {% if user_form.first_name.errors %}
                  <p class="help is-danger">{{ user_form.first_name.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-6">
              <div class="field">
                {{ user_form.last_name.label_tag }}
                <div class="control">
                  {{ user_form.last_name }}
                </div>
                {% if user_form.last_name.errors %}
                  <p class="help is-danger">{{ user_form.last_name.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-6">
              <div class="field">
                {{ user_form.password1.label_tag }}
                <div class="control">
                  {{ user_form.password1 }}
                </div>
                {% if user_form.password1.errors %}
                  <p class="help is-danger">{{ user_form.password1.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-6">
              <div class="field">
                {{ user_form.password2.label_tag }}
                <div class="control">
                  {{ user_form.password2 }}
                </div>
                {% if user_form.password2.errors %}
                  <p class="help is-danger">{{ user_form.password2.errors.0 }}</p>
                {% endif %}
              </div>
            </div>
            <div class="column is-12">
              <label class="checkbox">
                {{ user_form.is_active }} <span>{{ user_form.is_active.label }}</span>
              </label>
              {% if user_form.is_active.errors %}
                <p class="help is-danger">{{ user_form.is_active.errors.0 }}</p>
              {% endif %}
            </div>
          </div>

          <hr>

          <h3 class="title is-6">Permissões e funções</h3>
          <div class="field">
            {{ profile_form.roles.label_tag }}
            <div class="control">
              {{ profile_form.roles }}
            </div>
            {% if profile_form.roles.help_text %}
              <p class="help">{{ profile_form.roles.help_text }}</p>
            {% endif %}
            {% if profile_form.roles.errors %}
              <p class="help is-danger">{{ profile_form.roles.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="field-group" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:0.6rem; margin-top:1rem;">
            {% for field in module_fields %}
              <label class="checkbox" style="padding:0.55rem 0.75rem; border:1px solid rgba(20,57,99,0.12); border-radius:var(--radius-sm); background:rgba(20,57,99,0.06);">
                {{ field }} <span>{{ field.label }}</span>
              </label>
            {% endfor %}
          </div>

          <div class="field" style="margin-top:1.2rem;">
            <p class="small text-muted" style="text-transform:uppercase; letter-spacing:0.12em; margin-bottom:0.5rem;">Permissões detalhadas de vendas</p>
            <div class="field-group" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.6rem;">
              {% for field in sales_permission_fields %}
                <label class="checkbox" style="padding:0.55rem 0.75rem; border:1px solid rgba(20,57,99,0.12); border-radius:var(--radius-sm); background:rgba(20,57,99,0.06);">
                  {{ field }} <span>{{ field.label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>

          <div class="field" style="margin-top:1.2rem;">
            {{ profile_form.companies.label_tag }}
            <div class="control">
              {{ profile_form.companies }}
            </div>
            {% if profile_form.companies.errors %}
              <p class="help is-danger">{{ profile_form.companies.errors.0 }}</p>
            {% else %}
              <p class="help">Selecione a(s) empresa(s) visíveis para o usuário. Deixe vazio para liberar todas.</p>
            {% endif %}
          </div>
          <div class="field">
            {{ profile_form.notes.label_tag }}
            <div class="control">
              {{ profile_form.notes }}
            </div>
            {% if profile_form.notes.errors %}
              <p class="help is-danger">{{ profile_form.notes.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="field is-grouped is-justify-content-flex-end" style="margin-top:1.25rem;">
            <div class="control">
              <a class="button" href="{% url 'core:settings_access' %}">Cancelar</a>
            </div>
            <div class="control">
              <button class="button is-primary" type="submit">Salvar usuário</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="column">
      <div class="box">
        <h3 class="title is-6">Orientações</h3>
        <p class="small text-muted">Após o cadastro, o usuário receberá um perfil de acesso com as funções selecionadas. É possível editar essas permissões a qualquer momento.</p>
      </div>
    </div>
  </div>
{% endblock %}
